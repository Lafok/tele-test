<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Harmonica</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-button: var(--tg-theme-button-color, #2481cc);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 15px;
            color: var(--tg-text);
            background-color: var(--tg-bg);
            -webkit-font-smoothing: antialiased;
        }
        .container { display: none; }
        #loader { text-align: center; padding-top: 50px; }
        #error { text-align: center; padding: 20px; color: #ff4d4d; }
        .tabs { display: flex; border-bottom: 1px solid var(--tg-hint); }
        .tab { padding: 10px 15px; cursor: pointer; color: var(--tg-hint); }
        .tab.active { color: var(--tg-text); border-bottom: 2px solid var(--tg-button); }
        .page { display: none; padding-top: 20px; }
        .page.active { display: block; }
        .info-block p { margin: 5px 0 15px; }
        .info-block strong { color: var(--tg-text); }
        .info-block span { color: var(--tg-hint); }
        .button {
            display: block; width: 100%; padding: 12px; margin-top: 20px;
            text-align: center; border: none; border-radius: 8px;
            background-color: var(--tg-button); color: var(--tg-button-text);
            font-size: 16px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

    <div id="loader">
        <p>Loading your Harmonica profile...</p>
    </div>

    <div id="error" style="display: none;"></div>

    <div id="app" class="container">
        <header>
            <h1 id="welcome-message"></h1>
        </header>

        <nav class="tabs">
            <div class="tab active" onclick="showPage('profile')">Profile</div>
            <div class="tab" onclick="showPage('billing')">Billing</div>
        </nav>

        <main>
            <div id="profile" class="page active">
                <div class="info-block">
                    <p><strong>Full Name:</strong> <span id="userName"></span></p>
                    <p><strong>Email:</strong> <span id="userEmail"></span></p>
                    <p><strong>User ID:</strong> <span id="userId"></span></p>
                </div>
                <button class="button" id="generateCredButton" onclick="generateAndSaveCredential()">Link this device</button>
            </div>

            <div id="billing" class="page">
                <h2>Your Billing</h2>
                <div class="info-block">
                    <p><strong>Subscription Plan:</strong> <span id="billingPlan"></span></p>
                    <p><strong>Next Billing Date:</strong> <span id="billingNextDate"></span></p>
                    <p>Billing history and options will be displayed here.</p>
                </div>
            </div>
        </main>
    </div>

    
<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // --- CONFIGURATION ---
    const backendUrl = 'https://62a23e3c63d7.ngrok-free.app'; // Используйте ваш актуальный URL
    const CREDENTIAL_KEY = 'harmonica_telegram_credential';
    const API_BASE_PATH = '/api/v1';

    // --- DOM ELEMENTS ---
    const loader = document.getElementById('loader');
    const errorDiv = document.getElementById('error');
    const appDiv = document.getElementById('app');
    const generateCredButton = document.getElementById('generateCredButton');

    // --- GLOBAL STATE ---
    let jwtToken = null;
    let currentUser = null;

    // --- FUNCTIONS ---

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelector(`.tab[onclick="showPage('${pageId}')"]`).classList.add('active');
        
        // --- ИСПРАВЛЕНИЕ: Этот блок теперь находится ВНУТРИ функции, где ему и место ---
        const billingPlanSpan = document.getElementById('billingPlan');
        if (pageId === 'billing' && billingPlanSpan.dataset.loaded !== 'true') {
            fetchBillingData();
        }
    }

    async function fetchBillingData() {
        const planSpan = document.getElementById('billingPlan');
        const dateSpan = document.getElementById('billingNextDate');
        try {
            planSpan.innerText = 'Loading...';
            dateSpan.innerText = '...';
            
            const billingInfo = await apiFetch(`${backendUrl}${API_BASE_PATH}/users/me/billing`);
            
            planSpan.innerText = billingInfo.planName;
            dateSpan.innerText = new Date(billingInfo.nextBillingDate).toLocaleDateString('en-GB');
            planSpan.dataset.loaded = 'true';
            
        } catch (error) {
            console.error("Failed to fetch billing data:", error);
            // Немного улучшил отображение ошибки, чтобы не затирать весь блок
            const billingDiv = document.getElementById('billing');
            if (!billingDiv.querySelector('.error-message')) {
                billingDiv.innerHTML += '<p class="error-message" style="color:red; font-size: 14px;">Could not load billing info.</p>';
            }
        }
    }
    
    function displayError(message) {
        loader.style.display = 'none';
        appDiv.style.display = 'none';
        errorDiv.style.display = 'block';
        errorDiv.innerText = message;
    }
    
    async function apiFetch(url, options = {}) {
        options.headers = {
            ...options.headers,
            'ngrok-skip-browser-warning': 'true'
        };
        if (jwtToken) {
            options.headers['Authorization'] = 'Bearer ' + jwtToken;
        }
        const response = await fetch(url, options);
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Server error ${response.status}: ${errorText}`);
        }
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) {
            return response.json();
        }
        return response.text();
    }

    function renderUserData(user) {
        currentUser = user;
        document.getElementById('welcome-message').innerText = `Welcome, ${user.firstName}!`;
        document.getElementById('userName').innerText = user.fullName;
        document.getElementById('userEmail').innerText = user.email;
        document.getElementById('userId').innerText = user.id;

        loader.style.display = 'none';
        appDiv.style.display = 'block';
    }

    async function fetchUserData() {
        try {
            const user = await apiFetch(`${backendUrl}${API_BASE_PATH}/users/me`);
            renderUserData(user);
            checkCredentialStatus();
        } catch (error) {
            console.error("Failed to fetch user data:", error);
            displayError("Could not load your profile. Please try restarting from Telegram.");
        }
    }

    function checkCredentialStatus() {
        const savedCredential = localStorage.getItem(CREDENTIAL_KEY);
        if (savedCredential) {
            generateCredButton.style.display = 'none';
        } else {
            generateCredButton.style.display = 'block';
        }
    }

    async function generateAndSaveCredential() {
        if (!currentUser) {
            displayError("User data not loaded. Cannot generate credential.");
            return;
        }
        try {
            generateCredButton.disabled = true;
            generateCredButton.innerText = 'Linking...';
            
            const rawCredential = await apiFetch(`${backendUrl}${API_BASE_PATH}/users/${currentUser.id}/telegram-credential`, { method: 'POST' });
            
            if (typeof rawCredential === 'string' && rawCredential.length > 10) {
                 localStorage.setItem(CREDENTIAL_KEY, rawCredential);
                 alert('Device linked successfully! You will now be logged in automatically.');
                 checkCredentialStatus();
            } else {
                throw new Error("Received an invalid credential from server.");
            }

        } catch (error) {
            console.error("Failed to generate credential:", error);
            alert("Failed to link device. Please try again.");
        } finally {
            generateCredButton.disabled = false;
            generateCredButton.innerText = 'Link this device';
        }
    }

    // --- MAIN LOGIC ---
    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const initialJwt = urlParams.get('cred');
        const savedCredential = localStorage.getItem(CREDENTIAL_KEY);
        
        try {
            if (savedCredential) {
                console.log("Found saved credential. Logging in...");
                const telegramUser = tg.initDataUnsafe?.user;
                if (!telegramUser) {
                    throw new Error("Could not get Telegram user data. Please restart from the app.");
                }
                
                const formData = new URLSearchParams();
                formData.append('telegram_id', telegramUser.id);
                formData.append('credential', savedCredential);
                
                const tokenResponse = await apiFetch(`${backendUrl}/api/telegram/login-by-credential`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                jwtToken = tokenResponse.token;

            } else if (initialJwt) {
                console.log("Found JWT in URL. Performing initial login...");
                jwtToken = initialJwt;
            } else {
                throw new Error("No login method available. Please start from the button in your Telegram chat.");
            }

            if (jwtToken) {
                await fetchUserData();
            } else {
                throw new Error("Authentication failed. Could not obtain a token.");
            }

        } catch (error) {
            console.error("Initialization failed:", error);
            displayError(error.message);
            localStorage.removeItem(CREDENTIAL_KEY);
        }
    });
</script>

</body>
</html>

