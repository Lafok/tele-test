<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Harmonica</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --tg-bg: var(--tg-theme-bg-color, #ffffff);
            --tg-text: var(--tg-theme-text-color, #000000);
            --tg-hint: var(--tg-theme-hint-color, #999999);
            --tg-button: var(--tg-theme-button-color, #2481cc);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 15px; color: var(--tg-text); background-color: var(--tg-bg); -webkit-font-smoothing: antialiased; }
        .screen { display: none; }
        #loader { text-align: center; padding-top: 50px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-size: 14px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid var(--tg-hint); border-radius: 4px; background-color: var(--tg-bg); color: var(--tg-text); box-sizing: border-box; font-size: 16px; }
        .button { display: block; width: 100%; padding: 12px; margin-top: 20px; text-align: center; border: none; border-radius: 8px; background-color: var(--tg-button); color: var(--tg-button-text); font-size: 16px; font-weight: bold; cursor: pointer; }
        .button:disabled { background-color: var(--tg-hint); }
        .error-message { text-align: center; padding: 10px; color: #ff4d4d; font-size: 14px; min-height: 1em; }
        .tabs { display: flex; border-bottom: 1px solid var(--tg-hint); }
        .tab { padding: 10px 15px; cursor: pointer; color: var(--tg-hint); }
        .tab.active { color: var(--tg-text); border-bottom: 2px solid var(--tg-button); }
        .page { display: none; padding-top: 20px; }
        .page.active { display: block; }
        .info-block p { margin: 5px 0 15px; }
        .date-selector-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .date-selector-container .form-group { flex: 1; margin-bottom: 0; }
    </style>
</head>
<body>

    <div id="loader" class="screen" style="display: block;">
        <p>Loading Harmonica...</p>
    </div>

    <div id="login-screen" class="screen">
        <h1>Link to Harmonica</h1>
        <p>Enter your Harmonica account details to link it with your Telegram account.</p>
        <div id="login-error" class="error-message"></div>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required autocomplete="email">
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required autocomplete="current-password">
            </div>
            <button type="submit" id="link-button" class="button">Link Account</button>
        </form>
    </div>

    <div id="app-screen" class="screen">
        <header><h1 id="welcome-message"></h1></header>
        <nav class="tabs">
            <div class="tab active" onclick="showPage('profile')">Profile</div>
            <div class="tab" onclick="showPage('billing')">Billing</div>
        </nav>
        <main>
            <div id="profile" class="page active">
                <div class="info-block">
                    <p><strong>Full Name:</strong> <span id="userName"></span></p>
                    <p><strong>Email:</strong> <span id="userEmail"></span></p>
                    <p><strong>User ID:</strong> <span id="userId"></span></p>
                </div>
                <button class="button" id="generateCredButton" onclick="generateAndSaveCredential()">Link this device for auto-login</button>
            </div>
            <div id="billing" class="page">
                <h2>Billing Information</h2>
                <div class="date-selector-container">
                    <div class="form-group">
                        <label for="year-selector">Year</label>
                        <select id="year-selector" onchange="fetchBillingData()"></select>
                    </div>
                    <div class="form-group">
                        <label for="month-selector">Month</label>
                        <select id="month-selector" onchange="fetchBillingData()"></select>
                    </div>
                </div>
                <div id="billing-results" class="info-block">
                    <p><strong>Total Calls:</strong> <span id="billingTotalCalls"></span></p>
                    <p><strong>Total Duration (sec):</strong> <span id="billingTotalDuration"></span></p>
                </div>
            </div>
        </main>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // --- CONFIGURATION ---
    const backendUrl = 'https://dashing-sawfly-stirring.ngrok-free.app'; // УБЕДИТЕСЬ, ЧТО ЭТОТ URL АКТУАЛЕН
    const API_BASE_PATH = '/api/v1';
    const CREDENTIAL_KEY = 'harmonica_telegram_credential';

    // --- GLOBAL STATE ---
    let jwtToken = null;
    let currentUser = null;
    const urlParams = new URLSearchParams(window.location.search);

    // --- CORE FUNCTIONS ---

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.getElementById(screenId).style.display = 'block';
    }

    async function apiFetch(url, options = {}) {
        options.headers = { ...options.headers, 'ngrok-skip-browser-warning': 'true' };
        if (jwtToken) { options.headers['Authorization'] = 'Bearer ' + jwtToken; }
        const response = await fetch(url, options);
        if (!response.ok) {
            const errorText = await response.text().catch(() => "Could not parse error response.");
            try {
                const errorJson = JSON.parse(errorText);
                throw new Error(errorJson.error || `Server error ${response.status}`);
            } catch (e) {
                throw new Error(`Server error ${response.status}: ${errorText}`);
            }
        }
        const contentType = response.headers.get("content-type");
        if (contentType && contentType.includes("application/json")) { return response.json(); }
        return response.text();
    }
    
    // --- APP SCREEN LOGIC ---
    
    function renderApp(user) {
        currentUser = user;
        document.getElementById('welcome-message').innerText = `Welcome, ${user.firstName}!`;
        document.getElementById('userName').innerText = user.fullName;
        document.getElementById('userEmail').innerText = user.email;
        document.getElementById('userId').innerText = user.id;
        checkCredentialStatus();
        showScreen('app-screen');
    }

    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelector(`.tab[onclick="showPage('${pageId}')"]`).classList.add('active');
        
        if (pageId === 'billing' && !document.getElementById('billingTotalCalls').innerText) {
            fetchBillingData();
        }
    }

    function populateDateSelectors() {
        const yearSelector = document.getElementById('year-selector');
        const monthSelector = document.getElementById('month-selector');
        const currentDate = new Date();
        const currentYear = currentDate.getFullYear();
        const currentMonth = currentDate.getMonth() + 1;

        for (let i = 0; i < 5; i++) {
            const year = currentYear - i;
            yearSelector.add(new Option(year, year));
        }
        const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        months.forEach((monthName, index) => {
            const monthValue = index + 1;
            monthSelector.add(new Option(monthName, monthValue));
        });

        yearSelector.value = currentYear;
        monthSelector.value = currentMonth;
    }

    async function fetchBillingData() {
        const callsSpan = document.getElementById('billingTotalCalls');
        const durationSpan = document.getElementById('billingTotalDuration');
        const year = document.getElementById('year-selector').value;
        const month = document.getElementById('month-selector').value;
        try {
            callsSpan.innerText = 'Loading...';
            durationSpan.innerText = '...';
            const url = `${backendUrl}${API_BASE_PATH}/users/me/billing?year=${year}&month=${month}`;
            const billingInfo = await apiFetch(url);
            callsSpan.innerText = billingInfo.totalCalls;
            durationSpan.innerText = billingInfo.totalDuration;
        } catch (error) {
            console.error("Failed to fetch billing data:", error);
            callsSpan.innerText = 'Error';
            durationSpan.innerText = 'Error';
        }
    }
    
    function checkCredentialStatus() {
        const savedCredential = localStorage.getItem(CREDENTIAL_KEY);
        document.getElementById('generateCredButton').style.display = savedCredential ? 'none' : 'block';
    }

    async function generateAndSaveCredential() {
        if (!currentUser) return alert("User data not loaded. Cannot generate credential.");
        const button = document.getElementById('generateCredButton');
        try {
            button.disabled = true;
            button.innerText = 'Linking...';
            const responseData = await apiFetch(`${backendUrl}/api/telegram/users/${currentUser.id}/credential`, { method: 'POST' });
            const rawCredential = responseData.credential;
            if (typeof rawCredential === 'string' && rawCredential.length > 10) {
                localStorage.setItem(CREDENTIAL_KEY, rawCredential);
                alert('Device linked successfully! You will now be logged in automatically.');
                checkCredentialStatus();
            } else {
                throw new Error("Received an invalid credential from server.");
            }
        } catch (error) {
            console.error("Failed to generate credential:", error);
            alert("Failed to link device. Please try again.");
        } finally {
            button.disabled = false;
            button.innerText = 'Link this device for auto-login';
        }
    }

    // --- LOGIN SCREEN LOGIC ---
    
    function showLoginScreen(errorMessage = '') {
        const errorDiv = document.getElementById('login-error');
        errorDiv.innerText = errorMessage;
        showScreen('login-screen');
    }

    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const linkButton = document.getElementById('link-button');
        const errorDiv = document.getElementById('login-error');
        linkButton.disabled = true;
        linkButton.innerText = 'Linking...';
        errorDiv.innerText = '';
        const requestBody = {
            email: document.getElementById('email').value,
            password: document.getElementById('password').value,
            telegramId: urlParams.get('telegram_id'),
            firstName: urlParams.get('first_name'),
            lastName: urlParams.get('last_name'),
            username: urlParams.get('username')
        };
        try {
            const data = await apiFetch(`${backendUrl}/api/telegram/link-account`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });
            jwtToken = data.token;
            await fetchInitialData();
        } catch (error) {
            console.error('Link failed:', error);
            errorDiv.innerText = error.message;
        } finally {
            linkButton.disabled = false;
            linkButton.innerText = 'Link Account';
        }
    });

    async function fetchInitialData() {
        try {
            const user = await apiFetch(`${backendUrl}/api/telegram/me`);
            renderApp(user);
        } catch (error) {
            console.error("Failed to fetch user data:", error);
            localStorage.removeItem(CREDENTIAL_KEY);
            showLoginScreen("Could not load your profile. Please log in again.");
        }
    }

    // --- INITIALIZATION ---
    
    async function initializeApp() {
        populateDateSelectors();
        const initialJwt = urlParams.get('cred');
        const savedCredential = localStorage.getItem(CREDENTIAL_KEY);
        try {
            if (savedCredential) {
                const telegramUser = tg.initDataUnsafe?.user;
                if (!telegramUser) { throw new Error("Could not get Telegram user data."); }
                const formData = new URLSearchParams();
                formData.append('telegram_id', telegramUser.id);
                formData.append('credential', savedCredential);
                const tokenResponse = await apiFetch(`${backendUrl}/api/telegram/login-by-credential`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                jwtToken = tokenResponse.token;
            } else if (initialJwt) {
                jwtToken = initialJwt;
            }

            if (jwtToken) {
                await fetchInitialData();
            } else {
                if (!urlParams.has('telegram_id')) {
                    showLoginScreen("Cannot identify Telegram user. Please start from the bot.");
                } else {
                    showLoginScreen();
                }
            }
        } catch (error) {
            console.error("Initialization failed:", error);
            localStorage.removeItem(CREDENTIAL_KEY);
            showLoginScreen(error.message || "An error occurred. Please try again.");
        }
    }

    document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>




